/**
 *** least.js 2
 *** Author: Kamil Czujowski - @kamilczujowski
 *** Version: 2.2.0
 *** Made with ?	in Hamburg, Germany.
 *** http://kamilczujowski.de
 **/
/*
 * @Modificado: Cristian Yunga
 * @Cambios: Adaptacion para Permitir la edicion de imagenes Recortar y Girar
 * @Fecha: 25-11-2015
 */
(function ($) {
    $.fn.least = function (options) {
        var settings = $.extend({
            'random': true,
            'scrollToGallery': true,
            'HiDPI': false,
            'var_control_ruta': false,
            'var_popup': false,// + funcion exclusiva de inicializacion del popup, por defecto es false
            'init_auto': false
        }, options);

        return this.each(function () {

            /* Open Images */
            function intipreview(object, path, caption, edition, id_img) {
                /*var */
                object.html('');
                var close = $('<figure class="close"></figure>'),
                        img = $('<img src="' + path + '" id="img_editting" />'),
                        thumb = $('li a'),
                        html_barra = '';
                var x = 0,
                        y = 0,
                        w = 0,
                        h = 0,
                        bandera = false,
                        jcrop_api;

                /* Load img */
                img.load(
                        function () {
                            /*NO UTILIZADO CON NUEVO CAMBIO*/
                            if (caption.length) {
                                object.html('<article>' + caption + '</article>');
                            } else {
                                object.html('');
                            }

                            /* Modificado: @CristianYunga
                             * Inserta botones para la edicion de la imagen
                             * Recortar Imagen (jCrop.js) y Girar
                             */
                            //if (Boolean(edition) === true) {
                                html_barra = '<div id="btn_guardar_img"><img src="/images/icon/save.png" border="0" style="width:25px;height:25px;" /> </div>';
                                html_barra += '<div id="btn_recortar_img"><img src="/images/icon/cut.png" border="0" style="width:25px;height:25px;" /> </div>';
                                html_barra += '<div id="btn_turn_left_img"><img src="/images/icon/rotate_left.png" border="0" style="width:25px;height:25px;" /> </div>';
                                html_barra += '<div id="btn_turn_right_img"><img src="/images/icon/rotate_right.png" border="0" style="width:25px;height:25px;" /> </div>';
                                html_barra += '<div id="btn_close_popup"><img src="/images/icon/close.png" border="0" style="width:25px;height:25px;" /> </div>';
                                object.html('<barra>' + html_barra + '</barra>');
                            //} else {
                                //object.html('');
                            //}

                            object
                                    .append(img)
                                    //.append(close)
                                    .slideDown('slow')
                            thumb.removeClass('load');

                            /*
                             * Funcion que inicializa las variables de x, y, w y h (x2 y y2)
                             * @param {type} c
                             * @returns {undefined}
                             */
                            function showCoords(c) {
                                x = c.x;
                                y = c.y;
                                w = c.w;
                                h = c.h;
                                bandera = true;
                                //console.log(x+" -- "+y+" -- "+w+" -- "+h);
                            }

                            //if (Boolean(edition) === true) {
                                /*
                                 * Uso pluging para efecto de recortar imagen
                                 */
                                $("#img_editting").Jcrop({
                                    onSelect: showCoords,
                                    bgColor: 'black',
                                    bgOpacity: .4
                                }, function () {
                                    jcrop_api = this;
                                    jcrop_api.setOptions({allowResize: 1});
                                });
                                /*
                                 * EVENTOS DE BOTONES DE EDICION
                                 */
                                /* btn_guardar */
                                $("#btn_guardar_img").on(
                                        'click',
                                        function () {
                                            control_ruta.upd_imgs=true;
                                            control_ruta.upload_img_edit(path, id_img, 0, '', 'A', 'S')
                                            /*if(control_ruta.upload_img_edit(path)){
                                             if(popup_img_cr){
                                             popup_img_cr.close();
                                             }
                                             }*/
                                        }
                                );
                                /* btn_recortar */
                                $("#btn_recortar_img").on(
                                        'click',
                                        function () {
                                            if (bandera) {
                                                var parametros = {accion: 'recortar_img', path_img: path, x: x, y: y, w: w, h: h};
                                                //console.log(x + " -- " + y + " -- " + w + " -- " + h);
                                                $.ajax({
                                                    data: parametros,
                                                    url: '/plugin_php/edit_img.php',
                                                    type: 'post',
                                                    beforeSend: function () {
                                                        //$("#resultado").html("Procesando, espere por favor...");
                                                    },
                                                    success: function (response) {
                                                        intipreview(object, response, "", true, id_img);
                                                        bandera = false;
                                                    }
                                                });
                                            }
                                        }
                                );
                                /* btn_giro_izq */
                                $("#btn_turn_left_img").on(
                                        'click',
                                        function () {
                                            var parametros = {accion: 'rotate_img', path_img: path, x: x, y: y, w: w, h: h, grade: 90};
                                            //console.log(x + " -- " + y + " -- " + w + " -- " + h);
                                            $.ajax({
                                                data: parametros,
                                                url: '/plugin_php/edit_img.php',
                                                type: 'post',
                                                beforeSend: function () {
                                                    //$("#resultado").html("Procesando, espere por favor...");
                                                },
                                                success: function (response) {
                                                    intipreview(object, response, "", true, id_img);
                                                    bandera = false;
                                                }
                                            });
                                        }
                                );
                                /* btn_giro_der */
                                $("#btn_turn_right_img").on(
                                        'click',
                                        function () {
                                            var parametros = {accion: 'rotate_img', path_img: path, x: x, y: y, w: w, h: h, grade: 270};
                                            //console.log(x + " -- " + y + " -- " + w + " -- " + h);
                                            $.ajax({
                                                data: parametros,
                                                url: '/plugin_php/edit_img.php',
                                                type: 'post',
                                                beforeSend: function () {
                                                    //$("#resultado").html("Procesando, espere por favor...");
                                                },
                                                success: function (response) {
                                                    intipreview(object, response, "", true, id_img);
                                                    bandera = false;
                                                }
                                            });
                                        }
                                );
                        
                                $("#btn_close_popup").on(
                                        'click',
                                function(){
                                    if(popup_img_cr){
                                        popup_img_cr.close();
                                    }
                                });
                            //}
                        }
                );

                /* Close Fullscreen */
                close.on(
                        'click',
                        function () {
                            $('.least-preview').slideToggle('slow');
                            thumb.removeClass('active');
                        }
                );

            }

            /* Thumbnail */
            $(this).find('li a').click(
                    function (e) {

                        /* var */
                        var $$ = $(this),
                                path = $$.attr('href'),
                                preview = $('.least-preview'),
                                previewImg = preview.children('img'),
                                caption = $$.attr('data-caption') || '',
                                edition = Boolean($$.attr('data-edition')),
                                id_img = $$.attr('data-id-img');

                        /* Same Image */
                        if (previewImg.length && path === previewImg.attr('src')) {
                            preview.slideToggle('slow');

                            $$.toggleClass('active');

                            return;
                        }

                        /* Other Image */
                        if (previewImg.length) {

                            $$.addClass('active');
                            $('.least-gallery li a.active').removeClass('active');

                            preview.slideUp(
                                    'slow',
                                    function () {
                                        intipreview(
                                                preview,
                                                path,
                                                caption,
                                                edition,
                                                id_img
                                                );
                                    }
                            );

                            /* First Image */
                        } else {
                            intipreview(
                                    preview,
                                    path,
                                    caption,
                                    edition,
                                    id_img
                                    );
                        }
                        $(".least-gallery").fadeOut(100);

                        /* Add Loading bar */
                        $$.addClass('load active');
                    }
            );

            /*
             * Inicializa variable global para popup, en caso de que se envie objeto de popup, para acceso de popup y cerrar
             * function
             */
            if (settings.var_popup) {
                var popup_img_cr = settings.var_popup;
            }

            if (settings.var_control_ruta) {
                var control_ruta = settings.var_control_ruta;
            }
            
            if (settings.init_auto) {
                $(this).find('li a').first().click();
            }

            /* Random Images - looked up from jquery forum */
            if (settings.random) {
                $('.least-gallery').each(function () {
                    var ul = $(this),
                            li = ul.children('li');

                    li.sort(function () {
                        var temp = parseInt(Math.random() * 8, null),
                                OddEven = temp % 4,
                                PosNeg = temp > 2 ? 1 : -1;

                        return (OddEven * PosNeg);
                    })
                            .appendTo(ul);
                });
            }

            /* Scroll to Top */
            if (settings.scrollToGallery) {
                $(this).find('li a').click(
                        function (e) {
                            e.preventDefault();

                            $('html, body').animate(
                                    {
                                        scrollTop: $('#least').offset().top
                                    }, 500
                                    );
                        }
                );
            }

            /* Support Retina Image - Inspiration https://bensmann.no */
            if (settings.HiDPI) {
                if (window.devicePixelRatio > 1) {
                    /* var's */
                    var image_thumb = $('#least img'),
                            image_big = $('#least a');

                    /* Replace images with @2x */
                    for (var i = 0; i < image_thumb.length && image_big.length; i++) {
                        var src = image_thumb[i].src,
                                href = image_big[i].href,
                                j = src.lastIndexOf('.'),
                                k = href.lastIndexOf('.');

                        src = src.substr(0, j) + '@2x' + src.substr(j);
                        href = href.substr(0, k) + '@2x' + href.substr(k);

                        image_thumb[i].src = src;
                        image_big[i].href = href;
                    }
                }
            }
        });
    };
})(jQuery);